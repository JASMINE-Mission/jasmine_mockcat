import numpy as np
import pandas as pd
import time
import argparse

def read_inputs():
    parser = argparse.ArgumentParser(description='Split the input sample into l,b bins within the specified range .')
    
    parser.add_argument('infile', type=str, help='Name of the file to process (.csv or .fits)')
    parser.add_argument('outfile', type=str, help='Name of the output file w/o extension')
    parser.add_argument("--lmin",default=-1.4,type=float,help="Smallest Gal. longitude (degrees)")
    parser.add_argument("--lmax",default=0.7,type=float,help="Largest Gal. longitude (degrees)")
    parser.add_argument("--bmin",default=-0.6,type=float,help="Smallest Gal. latitude (degrees)")
    parser.add_argument("--bmax",default=0.6,type=float,help="Largest Gal. latitude (degrees)")
    parser.add_argument("--dl",default=0.025,type=float,help="Binsize in Gal. longitude (degrees)")
    parser.add_argument("--db",default=0.025,type=float,help="Binsize in Gal. latitude (degrees)")
    parser.add_argument("--magmin",default=9.5,type=float,help="Smallest magnitude (mag)")
    parser.add_argument("--magmax",default=14.5,type=float,help="Largest magnitude (mag)")
    parser.add_argument("--glonrow",type=str,help="Name of the row in infile containing the Gal. longitude",required=False,default="glon")
    parser.add_argument("--glatrow",type=str,help="Name of the row in infile containing the Gal. latitude",required=False,default="glat")
    parser.add_argument("--magrow",type=str,help="Name of the row in infile containing the magnitude",required=False,default="phot_hw_mag")
    args = parser.parse_args()
    
    return args


bbins = np.array([-9.9875, -9.9625, -9.9375, -9.9125, -9.8875, -9.8625, -9.8375,
       -9.8125, -9.7875, -9.7625, -9.7375, -9.7125, -9.6875, -9.6625,
       -9.6375, -9.6125, -9.5875, -9.5625, -9.5375, -9.5125, -9.4875,
       -9.4625, -9.4375, -9.4125, -9.3875, -9.3625, -9.3375, -9.3125,
       -9.2875, -9.2625, -9.2375, -9.2125, -9.1875, -9.1625, -9.1375,
       -9.1125, -9.0875, -9.0625, -9.0375, -9.0125, -8.9875, -8.9625,
       -8.9375, -8.9125, -8.8875, -8.8625, -8.8375, -8.8125, -8.7875,
       -8.7625, -8.7375, -8.7125, -8.6875, -8.6625, -8.6375, -8.6125,
       -8.5875, -8.5625, -8.5375, -8.5125, -8.4875, -8.4625, -8.4375,
       -8.4125, -8.3875, -8.3625, -8.3375, -8.3125, -8.2875, -8.2625,
       -8.2375, -8.2125, -8.1875, -8.1625, -8.1375, -8.1125, -8.0875,
       -8.0625, -8.0375, -8.0125, -7.9875, -7.9625, -7.9375, -7.9125,
       -7.8875, -7.8625, -7.8375, -7.8125, -7.7875, -7.7625, -7.7375,
       -7.7125, -7.6875, -7.6625, -7.6375, -7.6125, -7.5875, -7.5625,
       -7.5375, -7.5125, -7.4875, -7.4625, -7.4375, -7.4125, -7.3875,
       -7.3625, -7.3375, -7.3125, -7.2875, -7.2625, -7.2375, -7.2125,
       -7.1875, -7.1625, -7.1375, -7.1125, -7.0875, -7.0625, -7.0375,
       -7.0125, -6.9875, -6.9625, -6.9375, -6.9125, -6.8875, -6.8625,
       -6.8375, -6.8125, -6.7875, -6.7625, -6.7375, -6.7125, -6.6875,
       -6.6625, -6.6375, -6.6125, -6.5875, -6.5625, -6.5375, -6.5125,
       -6.4875, -6.4625, -6.4375, -6.4125, -6.3875, -6.3625, -6.3375,
       -6.3125, -6.2875, -6.2625, -6.2375, -6.2125, -6.1875, -6.1625,
       -6.1375, -6.1125, -6.0875, -6.0625, -6.0375, -6.0125, -5.9875,
       -5.9625, -5.9375, -5.9125, -5.8875, -5.8625, -5.8375, -5.8125,
       -5.7875, -5.7625, -5.7375, -5.7125, -5.6875, -5.6625, -5.6375,
       -5.6125, -5.5875, -5.5625, -5.5375, -5.5125, -5.4875, -5.4625,
       -5.4375, -5.4125, -5.3875, -5.3625, -5.3375, -5.3125, -5.2875,
       -5.2625, -5.2375, -5.2125, -5.1875, -5.1625, -5.1375, -5.1125,
       -5.0875, -5.0625, -5.0375, -5.0125, -4.9875, -4.9625, -4.9375,
       -4.9125, -4.8875, -4.8625, -4.8375, -4.8125, -4.7875, -4.7625,
       -4.7375, -4.7125, -4.6875, -4.6625, -4.6375, -4.6125, -4.5875,
       -4.5625, -4.5375, -4.5125, -4.4875, -4.4625, -4.4375, -4.4125,
       -4.3875, -4.3625, -4.3375, -4.3125, -4.2875, -4.2625, -4.2375,
       -4.2125, -4.1875, -4.1625, -4.1375, -4.1125, -4.0875, -4.0625,
       -4.0375, -4.0125, -3.9875, -3.9625, -3.9375, -3.9125, -3.8875,
       -3.8625, -3.8375, -3.8125, -3.7875, -3.7625, -3.7375, -3.7125,
       -3.6875, -3.6625, -3.6375, -3.6125, -3.5875, -3.5625, -3.5375,
       -3.5125, -3.4875, -3.4625, -3.4375, -3.4125, -3.3875, -3.3625,
       -3.3375, -3.3125, -3.2875, -3.2625, -3.2375, -3.2125, -3.1875,
       -3.1625, -3.1375, -3.1125, -3.0875, -3.0625, -3.0375, -3.0125,
       -2.9875, -2.9625, -2.9375, -2.9125, -2.8875, -2.8625, -2.8375,
       -2.8125, -2.7875, -2.7625, -2.7375, -2.7125, -2.6875, -2.6625,
       -2.6375, -2.6125, -2.5875, -2.5625, -2.5375, -2.5125, -2.4875,
       -2.4625, -2.4375, -2.4125, -2.3875, -2.3625, -2.3375, -2.3125,
       -2.2875, -2.2625, -2.2375, -2.2125, -2.1875, -2.1625, -2.1375,
       -2.1125, -2.0875, -2.0625, -2.0375, -2.0125, -1.9875, -1.9625,
       -1.9375, -1.9125, -1.8875, -1.8625, -1.8375, -1.8125, -1.7875,
       -1.7625, -1.7375, -1.7125, -1.6875, -1.6625, -1.6375, -1.6125,
       -1.5875, -1.5625, -1.5375, -1.5125, -1.4875, -1.4625, -1.4375,
       -1.4125, -1.3875, -1.3625, -1.3375, -1.3125, -1.2875, -1.2625,
       -1.2375, -1.2125, -1.1875, -1.1625, -1.1375, -1.1125, -1.0875,
       -1.0625, -1.0375, -1.0125, -0.9875, -0.9625, -0.9375, -0.9125,
       -0.8875, -0.8625, -0.8375, -0.8125, -0.7875, -0.7625, -0.7375,
       -0.7125, -0.6875, -0.6625, -0.6375, -0.6125, -0.5875, -0.5625,
       -0.5375, -0.5125, -0.4875, -0.4625, -0.4375, -0.4125, -0.3875,
       -0.3625, -0.3375, -0.3125, -0.2875, -0.2625, -0.2375, -0.2125,
       -0.1875, -0.1625, -0.1375, -0.1125, -0.0875, -0.0625, -0.0375,
       -0.0125,  0.0125,  0.0375,  0.0625,  0.0875,  0.1125,  0.1375,
        0.1625,  0.1875,  0.2125,  0.2375,  0.2625,  0.2875,  0.3125,
        0.3375,  0.3625,  0.3875,  0.4125,  0.4375,  0.4625,  0.4875,
        0.5125,  0.5375,  0.5625,  0.5875,  0.6125,  0.6375,  0.6625,
        0.6875,  0.7125,  0.7375,  0.7625,  0.7875,  0.8125,  0.8375,
        0.8625,  0.8875,  0.9125,  0.9375,  0.9625,  0.9875,  1.0125,
        1.0375,  1.0625,  1.0875,  1.1125,  1.1375,  1.1625,  1.1875,
        1.2125,  1.2375,  1.2625,  1.2875,  1.3125,  1.3375,  1.3625,
        1.3875,  1.4125,  1.4375,  1.4625,  1.4875,  1.5125,  1.5375,
        1.5625,  1.5875,  1.6125,  1.6375,  1.6625,  1.6875,  1.7125,
        1.7375,  1.7625,  1.7875,  1.8125,  1.8375,  1.8625,  1.8875,
        1.9125,  1.9375,  1.9625,  1.9875,  2.0125,  2.0375,  2.0625,
        2.0875,  2.1125,  2.1375,  2.1625,  2.1875,  2.2125,  2.2375,
        2.2625,  2.2875,  2.3125,  2.3375,  2.3625,  2.3875,  2.4125,
        2.4375,  2.4625,  2.4875,  2.5125,  2.5375,  2.5625,  2.5875,
        2.6125,  2.6375,  2.6625,  2.6875,  2.7125,  2.7375,  2.7625,
        2.7875,  2.8125,  2.8375,  2.8625,  2.8875,  2.9125,  2.9375,
        2.9625,  2.9875,  3.0125,  3.0375,  3.0625,  3.0875,  3.1125,
        3.1375,  3.1625,  3.1875,  3.2125,  3.2375,  3.2625,  3.2875,
        3.3125,  3.3375,  3.3625,  3.3875,  3.4125,  3.4375,  3.4625,
        3.4875,  3.5125,  3.5375,  3.5625,  3.5875,  3.6125,  3.6375,
        3.6625,  3.6875,  3.7125,  3.7375,  3.7625,  3.7875,  3.8125,
        3.8375,  3.8625,  3.8875,  3.9125,  3.9375,  3.9625,  3.9875,
        4.0125,  4.0375,  4.0625,  4.0875,  4.1125,  4.1375,  4.1625,
        4.1875,  4.2125,  4.2375,  4.2625,  4.2875,  4.3125,  4.3375,
        4.3625,  4.3875,  4.4125,  4.4375,  4.4625,  4.4875])

lbins = np.array([-9.4875, -9.4625, -9.4375, -9.4125, -9.3875, -9.3625, -9.3375,
       -9.3125, -9.2875, -9.2625, -9.2375, -9.2125, -9.1875, -9.1625,
       -9.1375, -9.1125, -9.0875, -9.0625, -9.0375, -9.0125, -8.9875,
       -8.9625, -8.9375, -8.9125, -8.8875, -8.8625, -8.8375, -8.8125,
       -8.7875, -8.7625, -8.7375, -8.7125, -8.6875, -8.6625, -8.6375,
       -8.6125, -8.5875, -8.5625, -8.5375, -8.5125, -8.4875, -8.4625,
       -8.4375, -8.4125, -8.3875, -8.3625, -8.3375, -8.3125, -8.2875,
       -8.2625, -8.2375, -8.2125, -8.1875, -8.1625, -8.1375, -8.1125,
       -8.0875, -8.0625, -8.0375, -8.0125, -7.9875, -7.9625, -7.9375,
       -7.9125, -7.8875, -7.8625, -7.8375, -7.8125, -7.7875, -7.7625,
       -7.7375, -7.7125, -7.6875, -7.6625, -7.6375, -7.6125, -7.5875,
       -7.5625, -7.5375, -7.5125, -7.4875, -7.4625, -7.4375, -7.4125,
       -7.3875, -7.3625, -7.3375, -7.3125, -7.2875, -7.2625, -7.2375,
       -7.2125, -7.1875, -7.1625, -7.1375, -7.1125, -7.0875, -7.0625,
       -7.0375, -7.0125, -6.9875, -6.9625, -6.9375, -6.9125, -6.8875,
       -6.8625, -6.8375, -6.8125, -6.7875, -6.7625, -6.7375, -6.7125,
       -6.6875, -6.6625, -6.6375, -6.6125, -6.5875, -6.5625, -6.5375,
       -6.5125, -6.4875, -6.4625, -6.4375, -6.4125, -6.3875, -6.3625,
       -6.3375, -6.3125, -6.2875, -6.2625, -6.2375, -6.2125, -6.1875,
       -6.1625, -6.1375, -6.1125, -6.0875, -6.0625, -6.0375, -6.0125,
       -5.9875, -5.9625, -5.9375, -5.9125, -5.8875, -5.8625, -5.8375,
       -5.8125, -5.7875, -5.7625, -5.7375, -5.7125, -5.6875, -5.6625,
       -5.6375, -5.6125, -5.5875, -5.5625, -5.5375, -5.5125, -5.4875,
       -5.4625, -5.4375, -5.4125, -5.3875, -5.3625, -5.3375, -5.3125,
       -5.2875, -5.2625, -5.2375, -5.2125, -5.1875, -5.1625, -5.1375,
       -5.1125, -5.0875, -5.0625, -5.0375, -5.0125, -4.9875, -4.9625,
       -4.9375, -4.9125, -4.8875, -4.8625, -4.8375, -4.8125, -4.7875,
       -4.7625, -4.7375, -4.7125, -4.6875, -4.6625, -4.6375, -4.6125,
       -4.5875, -4.5625, -4.5375, -4.5125, -4.4875, -4.4625, -4.4375,
       -4.4125, -4.3875, -4.3625, -4.3375, -4.3125, -4.2875, -4.2625,
       -4.2375, -4.2125, -4.1875, -4.1625, -4.1375, -4.1125, -4.0875,
       -4.0625, -4.0375, -4.0125, -3.9875, -3.9625, -3.9375, -3.9125,
       -3.8875, -3.8625, -3.8375, -3.8125, -3.7875, -3.7625, -3.7375,
       -3.7125, -3.6875, -3.6625, -3.6375, -3.6125, -3.5875, -3.5625,
       -3.5375, -3.5125, -3.4875, -3.4625, -3.4375, -3.4125, -3.3875,
       -3.3625, -3.3375, -3.3125, -3.2875, -3.2625, -3.2375, -3.2125,
       -3.1875, -3.1625, -3.1375, -3.1125, -3.0875, -3.0625, -3.0375,
       -3.0125, -2.9875, -2.9625, -2.9375, -2.9125, -2.8875, -2.8625,
       -2.8375, -2.8125, -2.7875, -2.7625, -2.7375, -2.7125, -2.6875,
       -2.6625, -2.6375, -2.6125, -2.5875, -2.5625, -2.5375, -2.5125,
       -2.4875, -2.4625, -2.4375, -2.4125, -2.3875, -2.3625, -2.3375,
       -2.3125, -2.2875, -2.2625, -2.2375, -2.2125, -2.1875, -2.1625,
       -2.1375, -2.1125, -2.0875, -2.0625, -2.0375, -2.0125, -1.9875,
       -1.9625, -1.9375, -1.9125, -1.8875, -1.8625, -1.8375, -1.8125,
       -1.7875, -1.7625, -1.7375, -1.7125, -1.6875, -1.6625, -1.6375,
       -1.6125, -1.5875, -1.5625, -1.5375, -1.5125, -1.4875, -1.4625,
       -1.4375, -1.4125, -1.3875, -1.3625, -1.3375, -1.3125, -1.2875,
       -1.2625, -1.2375, -1.2125, -1.1875, -1.1625, -1.1375, -1.1125,
       -1.0875, -1.0625, -1.0375, -1.0125, -0.9875, -0.9625, -0.9375,
       -0.9125, -0.8875, -0.8625, -0.8375, -0.8125, -0.7875, -0.7625,
       -0.7375, -0.7125, -0.6875, -0.6625, -0.6375, -0.6125, -0.5875,
       -0.5625, -0.5375, -0.5125, -0.4875, -0.4625, -0.4375, -0.4125,
       -0.3875, -0.3625, -0.3375, -0.3125, -0.2875, -0.2625, -0.2375,
       -0.2125, -0.1875, -0.1625, -0.1375, -0.1125, -0.0875, -0.0625,
       -0.0375, -0.0125,  0.0125,  0.0375,  0.0625,  0.0875,  0.1125,
        0.1375,  0.1625,  0.1875,  0.2125,  0.2375,  0.2625,  0.2875,
        0.3125,  0.3375,  0.3625,  0.3875,  0.4125,  0.4375,  0.4625,
        0.4875,  0.5125,  0.5375,  0.5625,  0.5875,  0.6125,  0.6375,
        0.6625,  0.6875,  0.7125,  0.7375,  0.7625,  0.7875,  0.8125,
        0.8375,  0.8625,  0.8875,  0.9125,  0.9375,  0.9625,  0.9875,
        1.0125,  1.0375,  1.0625,  1.0875,  1.1125,  1.1375,  1.1625,
        1.1875,  1.2125,  1.2375,  1.2625,  1.2875,  1.3125,  1.3375,
        1.3625,  1.3875,  1.4125,  1.4375,  1.4625,  1.4875,  1.5125,
        1.5375,  1.5625,  1.5875,  1.6125,  1.6375,  1.6625,  1.6875,
        1.7125,  1.7375,  1.7625,  1.7875,  1.8125,  1.8375,  1.8625,
        1.8875,  1.9125,  1.9375,  1.9625,  1.9875,  2.0125,  2.0375,
        2.0625,  2.0875,  2.1125,  2.1375,  2.1625,  2.1875,  2.2125,
        2.2375,  2.2625,  2.2875,  2.3125,  2.3375,  2.3625,  2.3875,
        2.4125,  2.4375,  2.4625,  2.4875,  2.5125,  2.5375,  2.5625,
        2.5875,  2.6125,  2.6375,  2.6625,  2.6875,  2.7125,  2.7375,
        2.7625,  2.7875,  2.8125,  2.8375,  2.8625,  2.8875,  2.9125,
        2.9375,  2.9625,  2.9875,  3.0125,  3.0375,  3.0625,  3.0875,
        3.1125,  3.1375,  3.1625,  3.1875,  3.2125,  3.2375,  3.2625,
        3.2875,  3.3125,  3.3375,  3.3625,  3.3875,  3.4125,  3.4375,
        3.4625,  3.4875,  3.5125,  3.5375,  3.5625,  3.5875,  3.6125,
        3.6375,  3.6625,  3.6875,  3.7125,  3.7375,  3.7625,  3.7875,
        3.8125,  3.8375,  3.8625,  3.8875,  3.9125,  3.9375,  3.9625,
        3.9875,  4.0125,  4.0375,  4.0625,  4.0875,  4.1125,  4.1375,
        4.1625,  4.1875,  4.2125,  4.2375,  4.2625,  4.2875,  4.3125,
        4.3375,  4.3625,  4.3875,  4.4125,  4.4375,  4.4625,  4.4875,
        4.5125,  4.5375,  4.5625,  4.5875,  4.6125,  4.6375,  4.6625,
        4.6875,  4.7125,  4.7375,  4.7625,  4.7875,  4.8125,  4.8375,
        4.8625,  4.8875,  4.9125,  4.9375,  4.9625,  4.9875,  5.0125,
        5.0375,  5.0625,  5.0875,  5.1125,  5.1375,  5.1625,  5.1875,
        5.2125,  5.2375,  5.2625,  5.2875,  5.3125,  5.3375,  5.3625,
        5.3875,  5.4125,  5.4375,  5.4625,  5.4875,  5.5125,  5.5375,
        5.5625,  5.5875,  5.6125,  5.6375,  5.6625,  5.6875,  5.7125,
        5.7375,  5.7625,  5.7875,  5.8125,  5.8375,  5.8625,  5.8875,
        5.9125,  5.9375,  5.9625,  5.9875,  6.0125,  6.0375,  6.0625,
        6.0875,  6.1125,  6.1375,  6.1625,  6.1875,  6.2125,  6.2375,
        6.2625,  6.2875,  6.3125,  6.3375,  6.3625,  6.3875,  6.4125,
        6.4375,  6.4625,  6.4875,  6.5125,  6.5375,  6.5625,  6.5875,
        6.6125,  6.6375,  6.6625,  6.6875,  6.7125,  6.7375,  6.7625,
        6.7875,  6.8125,  6.8375,  6.8625,  6.8875,  6.9125,  6.9375,
        6.9625,  6.9875,  7.0125,  7.0375,  7.0625,  7.0875,  7.1125,
        7.1375,  7.1625,  7.1875,  7.2125,  7.2375,  7.2625,  7.2875,
        7.3125,  7.3375,  7.3625,  7.3875,  7.4125,  7.4375,  7.4625,
        7.4875,  7.5125,  7.5375,  7.5625,  7.5875,  7.6125,  7.6375,
        7.6625,  7.6875,  7.7125,  7.7375,  7.7625,  7.7875,  7.8125,
        7.8375,  7.8625,  7.8875,  7.9125,  7.9375,  7.9625,  7.9875,
        8.0125,  8.0375,  8.0625,  8.0875,  8.1125,  8.1375,  8.1625,
        8.1875,  8.2125,  8.2375,  8.2625,  8.2875,  8.3125,  8.3375,
        8.3625,  8.3875,  8.4125,  8.4375,  8.4625,  8.4875,  8.5125,
        8.5375,  8.5625,  8.5875,  8.6125,  8.6375,  8.6625,  8.6875,
        8.7125,  8.7375,  8.7625,  8.7875,  8.8125,  8.8375,  8.8625,
        8.8875,  8.9125,  8.9375,  8.9625,  8.9875,  9.0125,  9.0375,
        9.0625,  9.0875,  9.1125,  9.1375,  9.1625,  9.1875,  9.2125,
        9.2375,  9.2625,  9.2875,  9.3125,  9.3375,  9.3625,  9.3875,
        9.4125,  9.4375,  9.4625,  9.4875])


if __name__ == "__main__":
    tstart = time.time()
    #read input from the terminal
    args = read_inputs()   
    
    lindex0 = ((lbins-args.lmin)>0).argmax() - 1
    lindex1 = ((lbins-args.lmax)>0).argmax()
    
    bindex0 = ((bbins-args.bmin)>0).argmax() - 1
    bindex1 = ((bbins-args.bmax)>0).argmax()
    
    print("Separating the sample {} into many small files, each one of size {}x{} between glon{}~{} and glat{}~{}, and magnitudes {}~{}".format(args.infile,args.dl,args.db,args.lmin,args.lmax,args.bmin,args.bmax,args.magmin,args.magmax))
    
    
    #read input file
    data = pd.read_csv(args.infile)
    #print(len(data),data.columns)
    
    #cut magnitudes
    sample = data[(data[args.magrow]>=args.magmin) & (data[args.magrow]<args.magmax)].copy()
    print("Number of stars in the sample within the magnitude limit: {} out of {}".format(len(sample),len(data)))
    del data

    for l in lbins[lindex0:lindex1]:
        for b in bbins[bindex0:bindex1]:
            subsample = sample[(sample[args.glonrow]>=(l-args.dl/2)) & (sample[args.glonrow]<(l+args.dl/2)) \
                               & (sample[args.glatrow]>=(b-args.db/2)) & (sample[args.glatrow]<(b+args.db/2))]
            if len(subsample)>0:
                subsample.to_csv(args.outfile+f"Mag{args.magmin}_{args.magmax}_glon{np.round(l,4)}_glat{np.round(b,4)}.csv",index=False)
